import React, { useState, useEffect } from 'react';

// Importaciones de Firebase (Necesarias para autenticación)
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';

// Variables globales proporcionadas por el entorno (IMPORTANTE)
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Inicialización de Firebase
let app, auth;
try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
} catch (error) {
    console.error("Error al inicializar Firebase. Verifique la configuración.", error);
}

// --- ARRAY DE DATOS LOCAL: USUARIO Y ROL ---
// En un sistema real, esta tabla se consultaría en la base de datos (Firestore o un backend).
const USER_ROLE_MAP = [
    { email: 'medico@sgh.com', role: 'Medico', password: 'password' },
    { email: 'admision@sgh.com', role: 'PersonalAdmision', password: 'password' },
    { email: 'facturacion@sgh.com', role: 'Facturacion', password: 'password' },
    { email: 'admin@sgh.com', role: 'Administrador', password: 'password' },
    { email: 'terapeuta@sgh.com', role: 'Terapeuta', password: 'password' },
    // Si el usuario no está aquí pero se autentica en Firebase, asumimos un rol por defecto.
];

// --- CONFIGURACIÓN DE MÓDULOS Y ROLES ---

// Definición de todos los módulos disponibles en el sistema
const MODULES = [
    { id: 'ADMISION', name: 'Admisión y Pacientes', description: 'Registro y gestión de pacientes (ADMISION.*)', icon: 'Users', color: 'sky-500', roles: ['Administrador', 'PersonalAdmision'] },
    { id: 'HCE', name: 'Historia Clínica (HCE)', description: 'Gestión de diagnósticos y notas de evolución (HCE.*)', icon: 'Stethoscope', color: 'green-500', roles: ['Administrador', 'Medico'] },
    { id: 'FACTURACION', name: 'Facturación y Cobros', description: 'Generación y seguimiento de facturas (FACTURACION.*)', icon: 'CreditCard', color: 'yellow-600', roles: ['Administrador', 'Facturacion'] },
    { id: 'TERAPIAS', name: 'Planes Terapéuticos', description: 'Registro de planes y sesiones de terapia (TERAPIAS.*)', icon: 'HeartPulse', color: 'purple-500', roles: ['Administrador', 'Medico', 'Terapeuta'] },
    { id: 'ADMIN_G', name: 'Configuración y Seguridad', description: 'Gestión de usuarios y catálogos (SEGURIDAD.*, MSTR.*)', icon: 'Settings', color: 'red-500', roles: ['Administrador'] }
];

// Mapeo de Redirección (Rol -> Módulo Principal al que accede después del login)
const ROLE_MAIN_MODULE_MAP = {
    'Administrador': 'ADMIN_G',
    'Medico': 'HCE',
    'PersonalAdmision': 'ADMISION',
    'Facturacion': 'FACTURACION',
    'Terapeuta': 'TERAPIAS'
};

// --- COMPONENTES DE ICONOS (SVG) ---
// Utilizado para evitar errores de compilación con bibliotecas externas

const Icon = ({ name, className }) => {
    const icons = {
        Users: (
            <g>
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </g>
        ),
        Stethoscope: (
            <g>
                <path d="M18 18l-3.5-3.5a2.12 2.12 0 0 0-3 3L15 21l3-3Z"/>
                <path d="M22 12A10 10 0 0 0 12 2v2a8 8 0 0 1 8 8h2Z"/>
                <path d="M12 2a10 10 0 0 0-5 1.5"/>
            </g>
        ),
        CreditCard: (
            <g>
                <rect width="20" height="14" x="2" y="5" rx="2"/>
                <line x1="2" x2="22" y1="10" y2="10"/>
            </g>
        ),
        HeartPulse: (
            <g>
                <path d="M3 10h2l1-4 3 6 2-3 1 4h3"/>
                <path d="M18 10h4"/>
            </g>
        ),
        Settings: (
            <g>
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.44.24a2 2 0 0 0-2.73-.73l-.15-.12a2 2 0 0 0-2.74.74l-.12.15a2 2 0 0 0-.73 2.73l.24.44a2 2 0 0 1 1.73 1L5 12.22l-.18.44a2 2 0 0 0 2 2h.18a2 2 0 0 1 1.73 1l.24.44a2 2 0 0 0-.73 2.73l-.15.12a2 2 0 0 0 .74 2.74l.15.12a2 2 0 0 0 2.73.73l.44-.24a2 2 0 0 1 1-1.73l.44-.24a2 2 0 0 0 2-2h-.18a2 2 0 0 1-1.73-1l-.44-.24a2 2 0 0 0 .73-2.73l.15-.12a2 2 0 0 0-.74-2.74l-.12-.15a2 2 0 0 0-2.73-.73l-.44.24a2 2 0 0 1-1.73 1L12.22 2Z"/>
                <circle cx="12" cy="12" r="3"/>
            </g>
        ),
    };
    return (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            {icons[name]}
        </svg>
    );
};


// --- FIREBASE HELPER FUNCTIONS (Simplificada) ---

/**
 * Determina el rol del usuario a partir del array local.
 * @param {string} email - Email del usuario autenticado.
 * @returns {string} El rol del usuario o 'PersonalAdmision' por defecto.
 */
const getRoleFromLocalMap = (email) => {
    const userEntry = USER_ROLE_MAP.find(u => u.email === email);
    return userEntry ? userEntry.role : 'PersonalAdmision'; 
};

// --- COMPONENTES DE VISTA ---

const LoginScreen = ({ onLogin, isLoading, errorMessage }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        onLogin(email, password);
    };

    return (
        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md animate-fadeIn">
            <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">
                Inicio de Sesión SGH
            </h2>
            <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor="email">Email</label>
                    <input
                        id="email"
                        type="email"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        placeholder="usuario@sgh.com"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"
                        required
                        disabled={isLoading}
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1" htmlFor="password">Contraseña</label>
                    <input
                        id="password"
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        placeholder="••••••••"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500"
                        required
                        disabled={isLoading}
                    />
                </div>
                {errorMessage && (
                    <p className="text-sm text-red-600 bg-red-50 p-3 rounded-lg border border-red-200">
                        {errorMessage}
                    </p>
                )}
                <button
                    type="submit"
                    className={`w-full py-3 rounded-lg text-lg font-bold transition duration-200 ${
                        isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-sky-600 hover:bg-sky-700 text-white shadow-lg shadow-sky-200'
                    }`}
                    disabled={isLoading}
                >
                    {isLoading ? 'Accediendo...' : 'Iniciar Sesión'}
                </button>
            </form>
            <div className="mt-6 text-center text-sm text-gray-500 p-3 bg-gray-50 rounded-lg">
                <p className="font-semibold mb-1">Cuentas de Prueba (Array local):</p>
                <p>Medico: <strong>medico@sgh.com</strong> / password</p>
                <p>Admisión: <strong>admision@sgh.com</strong> / password</p>
                <p>Facturación: <strong>facturacion@sgh.com</strong> / password</p>
                <p className="mt-2 text-xs">Cualquier otra cuenta que se autentique tendrá el rol por defecto 'PersonalAdmision'.</p>
            </div>
        </div>
    );
};


const DashboardScreen = ({ userRole, onLogout, onModuleClick }) => {
    
    // Filtramos los módulos que coinciden con el rol del usuario
    const allowedModules = MODULES.filter(module => module.roles.includes(userRole));
    
    return (
        <div className="animate-fadeIn w-full">
            <div className="flex justify-between items-center mb-8 p-6 bg-white rounded-xl shadow-xl border-l-4 border-indigo-600">
                <div>
                    <h2 className="text-3xl font-bold text-gray-800">
                        Dashboard de Módulos
                    </h2>
                    <p className="text-lg text-indigo-600 mt-1">
                        Bienvenido, <span className="font-extrabold">{userRole}</span>.
                    </p>
                </div>
                <button 
                    onClick={onLogout}
                    className="flex items-center space-x-2 px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 font-semibold transition duration-200 shadow-md"
                >
                    <Icon name="Users" className="w-5 h-5" />
                    <span>Cerrar Sesión</span>
                </button>
            </div>

            <h3 className="text-xl font-semibold text-gray-700 mb-4">
                Módulos disponibles ({allowedModules.length})
            </h3>

            {allowedModules.length === 0 ? (
                <p className="text-lg text-gray-500 italic p-6 bg-yellow-50 rounded-lg">
                    No tienes permisos asignados a ningún módulo en este momento.
                </p>
            ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    {allowedModules.map(module => (
                        <div
                            key={module.id}
                            onClick={() => onModuleClick(module)}
                            className={`module-card bg-white p-6 rounded-xl shadow-md hover:shadow-xl cursor-pointer transition duration-200 border-l-4 border-${module.color} hover:ring-4 hover:ring-${module.color}/20`}
                        >
                            <div className="flex items-center space-x-4 mb-4">
                                <div className={`p-3 rounded-full bg-${module.color}/10 text-${module.color}`}>
                                    <Icon name={module.icon} className="w-6 h-6" />
                                </div>
                                <h4 className="text-xl font-bold text-gray-900">{module.name}</h4>
                            </div>
                            <p className="text-gray-600 text-sm">{module.description}</p>
                            <span className={`mt-4 inline-block text-xs font-semibold py-1 px-3 rounded-full bg-${module.color}/20 text-${module.color}`}>
                                {module.id}
                            </span>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

// Componente principal de la aplicación
const App = () => {
    const [authState, setAuthState] = useState({
        user: null,
        role: null,
        loading: true,
        error: null,
    });
    const [activeView, setActiveView] = useState('login'); // 'login' | 'dashboard' | 'module-detail'
    const [selectedModule, setSelectedModule] = useState(null);
    const [loginError, setLoginError] = useState(null);
    const [isLoggingIn, setIsLoggingIn] = useState(false);

    // 1. Manejo de la Autenticación y Carga de Rol
    useEffect(() => {
        if (!auth) return;

        const unsubscribe = onAuthStateChanged(auth, (user) => {
            if (user) {
                // Obtener el rol del array local inmediatamente después de la autenticación
                const userRole = getRoleFromLocalMap(user.email);
                
                setAuthState({
                    user: user,
                    role: userRole,
                    loading: false,
                    error: null,
                });

                // Redirigir al módulo principal del rol
                const mainModuleId = ROLE_MAIN_MODULE_MAP[userRole];
                if (mainModuleId) {
                    const moduleInfo = MODULES.find(m => m.id === mainModuleId);
                    setSelectedModule(moduleInfo);
                    setActiveView('module-detail');
                } else {
                    setActiveView('dashboard');
                }
            } else {
                // Usuario desconectado
                setAuthState({ user: null, role: null, loading: false, error: null });
                setActiveView('login');
            }
        });

        // Manejo del custom token inicial del entorno
        const authenticateInitialUser = async () => {
            if (initialAuthToken && !auth.currentUser) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (e) {
                    console.error("[Auth] Error al iniciar sesión con custom token:", e);
                }
            } else if (!auth.currentUser) {
                setAuthState(prev => ({ ...prev, loading: false }));
            }
        };

        authenticateInitialUser();

        return () => unsubscribe(); // Limpieza del listener
    }, []);


    // 2. Lógica de Login (Ahora solo usa Firebase para auth, el rol es local)
    const handleLogin = async (email, password) => {
        setLoginError(null);
        setIsLoggingIn(true);

        try {
            // 1. Intentar autenticación con Firebase
            await signInWithEmailAndPassword(auth, email, password);
            
            // 2. onAuthStateChanged se disparará automáticamente al haber un login exitoso,
            // y luego se usará el mapeo local para determinar el rol.

        } catch (error) {
            console.error("Error de autenticación:", error);
            let message = "Credenciales incorrectas o error desconocido.";
            if (error.code === 'auth/invalid-email' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                message = "Email o contraseña inválidos.";
            } else if (error.code === 'auth/operation-not-allowed') {
                message = "El inicio de sesión con Email/Password no está habilitado.";
            }
            setLoginError(message);
        } finally {
            setIsLoggingIn(false);
        }
    };

    // 3. Lógica de Logout
    const handleLogout = () => {
        auth.signOut();
        setLoginError(null);
        setSelectedModule(null);
    };

    // 4. Lógica de Navegación
    const handleModuleClick = (module) => {
        setSelectedModule(module);
        setActiveView('module-detail');
    };

    const handleBackToDashboard = () => {
        setSelectedModule(null);
        setActiveView('dashboard');
    };

    // --- Renderizado Condicional ---

    if (authState.loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-f0f2f5">
                <div className="text-xl font-semibold text-sky-600 animate-pulse">Cargando Sistema...</div>
            </div>
        );
    }

    if (!authState.user) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-f0f2f5 p-4">
                <LoginScreen onLogin={handleLogin} isLoading={isLoggingIn} errorMessage={loginError} />
            </div>
        );
    }
    
    // Una vez autenticado, redirigimos a la vista correspondiente
    const renderContent = () => {
        if (!authState.role) {
             return (
                <div className="p-8 bg-red-100 rounded-xl shadow-xl text-red-800">
                    <h3 className="text-2xl font-bold mb-3">Error de Permisos</h3>
                    <p className="text-lg">No se pudo determinar su rol en el sistema. Por favor, contacte a soporte.</p>
                    <button 
                        onClick={handleLogout}
                        className="mt-4 px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 font-semibold transition shadow-md"
                    >
                        Volver a Intentar
                    </button>
                </div>
            );
        }

        switch (activeView) {
            case 'dashboard':
                return (
                    <DashboardScreen 
                        userRole={authState.role} 
                        onLogout={handleLogout} 
                        onModuleClick={handleModuleClick} 
                    />
                );
            case 'module-detail':
                // Vista del Módulo Principal (Redirección Inicial o Clic en Dashboard)
                return (
                    <div className="animate-fadeIn w-full">
                        <div className="flex justify-between items-center mb-8 p-6 bg-white rounded-xl shadow-xl border-l-4 border-indigo-600">
                            <h2 className="text-3xl font-bold text-gray-800">{selectedModule.name}</h2>
                            <button 
                                onClick={handleBackToDashboard}
                                className="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 font-semibold transition shadow-md"
                            >
                                <span className="hidden sm:inline">Volver al Dashboard</span>
                                <span className="inline sm:hidden">Volver</span>
                            </button>
                        </div>

                        <div className="p-8 bg-indigo-50 rounded-xl shadow-inner text-indigo-700">
                            <h3 className="text-2xl font-bold mb-3">Flujo Principal del Rol: {authState.role}</h3>
                            <p className="text-lg">
                                Ha accedido al módulo principal <strong>{selectedModule.name}</strong>.
                            </p>
                            <p className="mt-4 border-t pt-3 border-indigo-200 text-gray-700">
                                En esta pantalla se cargaría la interfaz principal del sistema, correspondiente a las tablas <span className="font-mono bg-gray-200 p-1 rounded text-sm text-gray-900">{selectedModule.id}.*</span>
                            </p>
                        </div>
                    </div>
                );
            default:
                return null; 
        }
    };


    return (
        <div className="min-h-screen bg-f0f2f5 p-4 sm:p-8">
            <div className="max-w-6xl mx-auto py-8">
                {renderContent()}
            </div>
        </div>
    );
};

export default App;