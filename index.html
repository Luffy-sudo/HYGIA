<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYGIA - Panel de Admisión</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro */
        }
        /* Estilos del Modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-open .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app-container" class="p-4 sm:p-8 flex justify-center">
        <div class="w-full max-w-6xl">

            <!-- Encabezado -->
            <header class="mb-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-indigo-600">
                <div class="flex justify-between items-center">
                    <h1 class="text-4xl font-extrabold text-indigo-800 flex items-center">
                        <!-- Icono de Hospital (Inline SVG de ejemplo) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 2L3 7v10l9 5 9-5V7z"></path><path d="M3 7l9 5 9-5"></path><path d="M12 2v15"></path><path d="M17 12h-2c-1.1 0-2-.9-2-2V7"></path><path d="M17 17h-5v-5"></path></svg>
                        HYGIA - Panel de Admisión
                    </h1>
                    <button id="logout-btn" class="flex items-center text-sm text-red-600 hover:text-red-800 font-semibold transition duration-150 p-2 rounded-lg bg-red-50 hover:bg-red-100">
                        <!-- Icono de Salir (Inline SVG) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Cerrar Sesión
                    </button>
                </div>
                <p class="text-gray-500 mt-2">Gestión centralizada de pacientes y estado de ingreso. <span class="font-bold text-red-500">(Datos Locales, No Persistentes)</span></p>
                <div id="error-message" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-lg" role="alert"></div>
            </header>

            <!-- Contenedor de Métricas -->
            <div id="stats-container" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Las tarjetas de estadísticas se inyectarán aquí -->
            </div>

            <!-- Controles y Listado de Pacientes -->
            <div class="bg-white rounded-xl shadow-2xl p-6">
                
                <!-- Barra de Búsqueda y Acción -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                    
                    <!-- Búsqueda -->
                    <div class="relative w-full sm:w-80">
                        <!-- Icono de Búsqueda (Inline SVG) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input
                            type="text"
                            id="search-input"
                            placeholder="Buscar por Nombre o ID..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                        />
                    </div>

                    <!-- Botón Añadir (Abrirá el Modal) -->
                    <button
                        id="add-patient-btn"
                        class="w-full sm:w-auto flex items-center justify-center px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.02]"
                    >
                        <!-- Icono Plus (Inline SVG) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Registrar Nuevo Paciente
                    </button>
                </div>
                
                <!-- Encabezado de la Tabla/Lista -->
                <div class="grid grid-cols-12 gap-4 text-xs font-semibold uppercase text-gray-500 border-b-2 pb-2 mb-2 px-4">
                    <div class="col-span-4">Paciente</div>
                    <div class="col-span-2 hidden sm:block">Área</div>
                    <div class="col-span-3 hidden md:block">Médico Asignado</div>
                    <div class="col-span-3 sm:col-span-3 md:col-span-2 text-right">Estado</div>
                </div>

                <!-- Lista de Pacientes -->
                <div id="patient-list" class="divide-y divide-gray-100">
                    <div id="loading-indicator" class="text-center py-10 text-gray-500">
                        Cargando pacientes...
                    </div>
                    <div id="no-patients-found" class="hidden text-center py-10 text-gray-500">
                        No se encontraron pacientes que coincidan con la búsqueda.
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- === MODAL DE REGISTRO DE PACIENTE === -->
    <div id="patient-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 modal-content">
            
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-indigo-700">Registrar Nuevo Paciente</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition">
                    <!-- Icono Cerrar (Inline SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <form id="new-patient-form" class="mt-4 space-y-4">
                <!-- Nombre Completo -->
                <div>
                    <label for="p-nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" id="p-nombre" name="nombre" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Identificación -->
                <div>
                    <label for="p-identificacion" class="block text-sm font-medium text-gray-700">Identificación (DNI/Cédula)</label>
                    <input type="text" id="p-identificacion" name="identificacion" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Fecha de Ingreso -->
                <div>
                    <label for="p-fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="p-fechaIngreso" name="fechaIngreso" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Área y Médico -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Área -->
                    <div>
                        <label for="p-area" class="block text-sm font-medium text-gray-700">Área/Unidad</label>
                        <select id="p-area" name="area" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Emergencias">Emergencias</option>
                            <option value="Medicina Interna">Medicina Interna</option>
                            <option value="Cirugía">Cirugía</option>
                            <option value="Pediatría">Pediatría</option>
                            <option value="UCI">UCI</option>
                        </select>
                    </div>
                    <!-- Médico Asignado -->
                    <div>
                        <label for="p-medico" class="block text-sm font-medium text-gray-700">Médico Asignado</label>
                        <input type="text" id="p-medico" name="medicoAsignado" required value="Dr. Pérez" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- Estado Inicial -->
                <div>
                    <label for="p-estado" class="block text-sm font-medium text-gray-700">Estado Inicial</label>
                    <select id="p-estado" name="estado" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Pendiente Admisión">Pendiente Admisión</option>
                        <option value="Admitido">Admitido</option>
                        <option value="Dado de Alta">Dado de Alta</option>
                    </select>
                </div>

                <!-- Botón de Envío -->
                <button 
                    type="submit" 
                    class="w-full py-2.5 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]"
                >
                    Guardar y Registrar Paciente
                </button>
            </form>
            
        </div>
    </div>
    <!-- FIN DEL MODAL -->

    <!-- Script de Lógica de la Aplicación (Array Local) -->
    <script type="module">
        // === COMPROBACIÓN DE SEGURIDAD ===
        const AUTH_KEY = 'hygia_authenticated';
        const isAuthenticated = sessionStorage.getItem(AUTH_KEY) === 'true';

        if (!isAuthenticated) {
            // Si no está autenticado, redirigir a la página de inicio de sesión
            window.location.href = 'login.html';
        }

        // === REFERENCIAS DEL DOM ===
        const errorMessageDiv = document.getElementById('error-message');
        const statsContainer = document.getElementById('stats-container');
        const patientListContainer = document.getElementById('patient-list');
        const searchInput = document.getElementById('search-input');
        const addPatientBtn = document.getElementById('add-patient-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noPatientsFound = document.getElementById('no-patients-found');
        const logoutBtn = document.getElementById('logout-btn');

        // Modal DOM
        const patientModal = document.getElementById('patient-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const newPatientForm = document.getElementById('new-patient-form');


        // === ESTADO GLOBAL Y DATOS DE PRUEBA ===
        let allPacientes = [
            { id: '1', nombre: 'Juan Pérez', identificacion: '4587', fechaIngreso: '2025-11-01', estado: 'Admitido', area: 'Pediatría', medicoAsignado: 'Dr. García', createdAt: 1 },
            { id: '2', nombre: 'María Rodríguez', identificacion: '9211', fechaIngreso: '2025-11-02', estado: 'Pendiente Admisión', area: 'Emergencias', medicoAsignado: 'Dra. Ana López', createdAt: 2 },
            { id: '3', nombre: 'Carlos Gámez', identificacion: '1432', fechaIngreso: '2025-11-03', estado: 'Dado de Alta', area: 'Cirugía', medicoAsignado: 'Dr. Hernádez', createdAt: 3 },
            { id: '4', nombre: 'Sofia Soto', identificacion: '6754', fechaIngreso: '2025-11-04', estado: 'Admitido', area: 'UCI', medicoAsignado: 'Dr. Mendoza', createdAt: 4 },
        ];
        let nextId = allPacientes.length + 1;


        // === FUNCIONES DE UTILIDAD Y MODAL ===

        function displayError(message) {
            console.error("HYGIA Error:", message);
            errorMessageDiv.textContent = `Error: ${message}`;
            errorMessageDiv.classList.remove('hidden');
        }

        function handleLogout() {
            sessionStorage.removeItem(AUTH_KEY);
            window.location.href = 'login.html';
        }
        
        function openModal() {
            patientModal.classList.remove('hidden');
            patientModal.classList.add('modal-open');
            // Establecer la fecha de hoy por defecto
            document.getElementById('p-fechaIngreso').value = new Date().toISOString().split('T')[0];
            document.body.classList.add('overflow-hidden'); // Prevenir scroll de fondo
        }

        function closeModal() {
            patientModal.classList.add('hidden');
            patientModal.classList.remove('modal-open');
            document.body.classList.remove('overflow-hidden');
            newPatientForm.reset(); // Limpiar el formulario al cerrar
        }


        // === LÓGICA DE DATOS Y RENDERIZADO ===
        
        function updateDashboard(pacientes, searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            const filteredPacientes = pacientes.filter(p => 
                (p.nombre?.toLowerCase().includes(term) || p.nombre === 'Sin Nombre') || 
                p.identificacion?.includes(term) ||
                p.area?.toLowerCase().includes(term)
            );

            // Ordenar por ID para simular un orden consistente
            filteredPacientes.sort((a, b) => parseInt(a.id) - parseInt(b.id));

            updateStats(pacientes);
            renderPatientList(filteredPacientes);
        }
        
        // Función para actualizar las tarjetas de métricas
        function updateStats(pacientes) {
            const total = pacientes.length;
            const admitidos = pacientes.filter(p => p.estado === 'Admitido').length;
            const pendientes = pacientes.filter(p => p.estado === 'Pendiente Admisión').length;
            const alta = pacientes.filter(p => p.estado === 'Dado de Alta').length;

            const statsData = [
                { title: "Pacientes Totales", value: total, icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-indigo-500 text-opacity-80"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><path d="M20 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16.5 7A4.5 4.5 0 0 1 21 12"></path></svg>`, color: "border-indigo-500" },
                { title: "Pendientes Admisión", value: pendientes, icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-500 text-opacity-80"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`, color: "border-yellow-500" },
                { title: "Pacientes Admitidos", value: admitidos, icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-500 text-opacity-80"><path d="M20 6L9 17l-5-5"></path></svg>`, color: "border-green-500" },
                { title: "Dados de Alta", value: alta, icon: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-500 text-opacity-80"><path d="M16 17l5-5-5-5"></path><path d="M5 12h16"></path></svg>`, color: "border-blue-500" },
            ];

            statsContainer.innerHTML = statsData.map(stat => `
                <div class="p-5 rounded-xl shadow-lg border-t-4 ${stat.color} bg-white transition duration-300 hover:shadow-xl">
                    <div class="flex items-center justify-between">
                        <div class="text-3xl font-bold text-gray-800">${stat.value}</div>
                        ${stat.icon}
                    </div>
                    <p class="text-sm font-medium text-gray-500 mt-1">${stat.title}</p>
                </div>
            `).join('');
        }
        
        // Función para renderizar la lista de pacientes
        function renderPatientList(pacientes) {
            patientListContainer.innerHTML = '';
            
            if (pacientes.length === 0) {
                loadingIndicator.classList.add('hidden');
                noPatientsFound.classList.remove('hidden');
                return;
            }

            loadingIndicator.classList.add('hidden');
            noPatientsFound.classList.add('hidden');

            pacientes.forEach(p => {
                let statusColor = 'bg-gray-100 text-gray-800';
                let statusDot = 'bg-gray-500';

                if (p.estado === 'Admitido') {
                    statusColor = 'bg-green-100 text-green-800';
                    statusDot = 'bg-green-500';
                } else if (p.estado === 'Pendiente Admisión') {
                    statusColor = 'bg-yellow-100 text-yellow-800';
                    statusDot = 'bg-yellow-500';
                } else if (p.estado === 'Dado de Alta') {
                    statusColor = 'bg-blue-100 text-blue-800';
                    statusDot = 'bg-blue-500';
                }

                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-4 items-center py-3 px-4 border-b hover:bg-indigo-50 transition duration-150';
                row.innerHTML = `
                    <!-- Nombre / ID -->
                    <div class="col-span-4 flex flex-col min-w-0">
                        <span class="font-semibold text-gray-900 truncate">${p.nombre || 'Sin Nombre'}</span>
                        <span class="text-xs text-gray-500">ID: ${p.identificacion}</span>
                    </div>
                    
                    <!-- Área -->
                    <div class="col-span-2 hidden sm:block text-sm text-gray-600 truncate">
                        ${p.area}
                    </div>

                    <!-- Médico -->
                    <div class="col-span-3 hidden md:block text-sm text-gray-600 truncate">
                        ${p.medicoAsignado}
                    </div>

                    <!-- Estado -->
                    <div class="col-span-3 sm:col-span-3 md:col-span-2 flex justify-end items-center">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor} flex items-center">
                            <span class="w-2 w-2 rounded-full mr-2 ${statusDot}"></span>
                            ${p.estado}
                        </span>
                        <select
                            data-patient-id="${p.id}"
                            data-current-status="${p.estado}"
                            class="status-select ml-2 bg-white border border-gray-300 rounded-lg p-1 text-xs focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer"
                        >
                            <option value="Pendiente Admisión" ${p.estado === 'Pendiente Admisión' ? 'selected' : ''}>Pendiente</option>
                            <option value="Admitido" ${p.estado === 'Admitido' ? 'selected' : ''}>Admitido</option>
                            <option value="Dado de Alta" ${p.estado === 'Dado de Alta' ? 'selected' : ''}>Alta</option>
                        </select>
                    </div>
                `;
                patientListContainer.appendChild(row);
            });

            // Re-añadir listeners para los selectores de estado
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const patientId = e.target.dataset.patientId;
                    const newStatus = e.target.value;
                    handleUpdatePatientStatus(patientId, newStatus);
                });
            });
        }

        // === FUNCIONES CRUD (Array Local) ===

        // Añadir paciente con datos del formulario
        function handleAddPatient(event) {
            event.preventDefault(); // Detener el envío del formulario
            
            try {
                // Obtener datos del formulario
                const form = event.target;
                const newPatientId = String(nextId++);

                const newPatient = {
                    id: newPatientId,
                    nombre: form.elements.nombre.value || 'Sin Nombre',
                    identificacion: form.elements.identificacion.value || 'N/A',
                    fechaIngreso: form.elements.fechaIngreso.value,
                    estado: form.elements.estado.value, 
                    area: form.elements.area.value,
                    medicoAsignado: form.elements.medicoAsignado.value,
                    createdAt: Date.now(),
                };

                allPacientes.push(newPatient);
                
                // Cerrar modal y actualizar la vista
                closeModal();
                updateDashboard(allPacientes, searchInput.value);

            } catch (e) {
                displayError(`No se pudo añadir el paciente: ${e.message}`);
            }
        }

        // Actualizar el estado del paciente (simula updateDoc)
        function handleUpdatePatientStatus(patientId, newStatus) {
            try {
                const patientIndex = allPacientes.findIndex(p => p.id === patientId);
                
                if (patientIndex > -1) {
                    allPacientes[patientIndex].estado = newStatus;
                } else {
                    displayError(`Paciente con ID ${patientId} no encontrado.`);
                }
                
                // Actualizar la vista después de modificar
                updateDashboard(allPacientes, searchInput.value);

            } catch (e) {
                displayError(`No se pudo actualizar el estado: ${e.message}`);
            }
        }

        // === LISTENERS DE EVENTOS ===

        searchInput.addEventListener('input', () => {
            updateDashboard(allPacientes, searchInput.value);
        });

        // Listeners del Modal
        addPatientBtn.addEventListener('click', openModal);
        closeModalBtn.addEventListener('click', closeModal);
        newPatientForm.addEventListener('submit', handleAddPatient);
        
        // Cerrar modal haciendo click fuera
        patientModal.addEventListener('click', (e) => {
            if (e.target === patientModal) {
                closeModal();
            }
        });
        
        // Cerrar modal con la tecla ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !patientModal.classList.contains('hidden')) {
                closeModal();
            }
        });
        
        // Listener de Logout
        logoutBtn.addEventListener('click', handleLogout);


        // === INICIO DE LA APLICACIÓN ===

        window.onload = () => {
            loadingIndicator.classList.add('hidden');
            updateDashboard(allPacientes, '');
        };
    </script>
</body>
</html>

